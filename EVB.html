<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>潤鉑 PCB 整合查詢系統 V1.0.4</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f7f6; }
        .container { max-width: 98%; margin: auto; background: white; padding: 20px; border-radius: 8px; }
        .section { border: 1px solid #ddd; padding: 15px; margin-bottom: 30px; border-radius: 5px; }
        h3 { border-left: 5px solid #333; padding-left: 10px; margin-bottom: 15px; }
        input { padding: 10px; width: 300px; font-size: 16px; border: 1px solid #ccc; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-left: 5px; }
        
        .table-res { width: 100%; overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; white-space: nowrap; }
        th { background: #eee; position: sticky; top: 0; }
        
        /* 廠商顏色底 (F欄) */
        .v-yusong { background-color: #ffcccc !important; color: black; } /* 紅底 */
        .v-speedy { background-color: #ffffcc !important; color: black; } /* 黃底 */
        .v-ching { background-color: #ccffcc !important; color: black; }  /* 綠底 */

        /* 類型顏色底 (E欄) */
        .t-pcb { background-color: #ccffcc !important; }   /* 綠底 */
        .t-assy { background-color: #ffcccc !important; }  /* 紅底 */
        .t-parts { background-color: #ffffcc !important; } /* 黃底 */
        .t-pcbassy { background-color: #cce5ff !important; } /* 藍底 */

        .loading { font-size: 14px; color: blue; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="section">
        <h3>區塊一：EVB_List 查詢</h3>
        <input type="text" id="inputEvb" placeholder="搜尋 C 欄 PCB Number">
        <button onclick="fetchData('evb', 'inputEvb', 'body1')">搜尋專案</button>
        <div class="table-res">
            <table><thead><tr id="head1"></tr></thead><tbody id="body1"></tbody></table>
        </div>
    </div>

    <div class="section">
        <h3>區塊二：DUT+PROBE_B 查詢</h3>
        <input type="text" id="inputDut" placeholder="關鍵字搜尋">
        <button onclick="fetchData('dut_project', 'inputDut', 'body2')">搜尋專案 (C欄)</button>
        <button onclick="fetchData('dut_vendor', 'inputDut', 'body2')">搜尋廠商 (F欄)</button>
        <div id="status2" class="loading"></div>
        <div class="table-res">
            <table><thead><tr id="head2"></tr></thead><tbody id="body2"></tbody></table>
        </div>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyn_JmQayzBYuM6leOHekuauIiSmXfP_fEvS7Auk-IGFxe2yULtzlf7ch3SysU-OuWbUQ/exec";

    async function fetchData(action, inputId, bodyId) {
        const key = document.getElementById(inputId).value;
        const head = document.getElementById(bodyId === 'body1' ? 'head1' : 'head2');
        const body = document.getElementById(bodyId);
        
        if(!key) return;
        body.innerHTML = "<tr><td colspan='20'>搜尋中...</td></tr>";

        try {
            const res = await fetch(`${GAS_URL}?key=${encodeURIComponent(key)}&action=${action}`);
            const data = await res.json();
            
            body.innerHTML = "";
            if (data.length === 0) {
                body.innerHTML = "<tr><td colspan='20'>無符合資料</td></tr>";
                return;
            }

            const headers = Object.keys(data[0]);
            head.innerHTML = headers.map(h => `<th>${h}</th>`).join('');

            data.forEach(item => {
                const tr = document.createElement('tr');
                headers.forEach((h, index) => {
                    const td = document.createElement('td');
                    let val = item[h];

                    // 金額格式化 (假設 G 欄在資料中名稱為 "Amount" 或第七個欄位)
                    // 這裡改用通用判斷：如果標題包含"金額"或"Cost"或"Price"且是數字
                    if (h.includes("金額") || h.includes("Cost") || h.includes("G") || index === 6) {
                        if(!isNaN(val) && val !== "") {
                            val = Number(val).toLocaleString();
                        }
                    }

                    td.innerText = val || "";

                    // 區塊二的顏色邏輯 (F欄與E欄索引需根據您工作表標題名稱)
                    // F欄：搜尋廠商 (假設標題為 Vendor 或欄位索引5)
                    const vendorStr = String(item[headers[5]] || "").toUpperCase();
                    if (vendorStr.includes("YUSONG")) td.classList.add('v-yusong');
                    if (vendorStr.includes("SPEEDY")) td.classList.add('v-speedy');
                    if (vendorStr.includes("CHING DENG")) td.classList.add('v-ching');

                    // E欄：類型 (假設標題為 Type 或欄位索引4)
                    const typeStr = String(item[headers[4]] || "").toUpperCase();
                    if (typeStr === "PCB") td.classList.add('t-pcb');
                    if (typeStr === "ASSY") td.classList.add('t-assy');
                    if (typeStr === "PARTS") td.classList.add('t-parts');
                    if (typeStr === "PCB+ASSY") td.classList.add('t-pcbassy');

                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });
        } catch (e) {
            body.innerHTML = "<tr><td colspan='20'>搜尋失敗</td></tr>";
        }
    }
</script>
</body>
</html>
