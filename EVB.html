<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ½¤é‰‘ PCB æ•´åˆç®¡ç†ç³»çµ± V1.0.7</title>
    <script src="config.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --border-color: #e2e8f0;
            /* ç‹€æ…‹è‰²èª¿ï¼šå„ªé›…ç‰ˆ */
            --status-green: #dcfce7; --text-green: #166534;
            --status-red: #fee2e2;   --text-red: #991b1b;
            --status-yellow: #fef9c3;--text-yellow: #854d0e;
            --status-blue: #dbeafe;  --text-blue: #1e40af;
        }

        body { 
            font-family: 'Inter', "Microsoft JhengHei", sans-serif; 
            background: var(--bg-color); color: var(--text-main);
            margin: 0; padding: 20px; line-height: 1.6;
        }

        .container { max-width: 1400px; margin: auto; }

        /* é ‚éƒ¨å°èˆªæ¬„ */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); padding: 15px 30px;
            border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            margin-bottom: 25px;
        }

        h2 { margin: 0; font-size: 24px; color: var(--primary-color); letter-spacing: 1px; }

        /* å€å¡Šå¡ç‰‡è¨­è¨ˆ */
        .section {
            background: var(--card-bg); padding: 25px;
            border-radius: 16px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            margin-bottom: 30px; border: 1px solid var(--border-color);
            transition: transform 0.2s;
        }

        h3 { 
            margin-top: 0; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;
            color: #334155; font-size: 18px; display: flex; align-items: center;
        }

        /* è¼¸å…¥èˆ‡æŒ‰éµç¾åŒ– */
        .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

        input[type="text"], select {
            padding: 12px 16px; font-size: 15px; border: 1px solid #cbd5e1;
            border-radius: 8px; outline: none; transition: all 0.2s; background: #fff;
        }
        
        /* æŒ‡å®šæœå°‹æ¡†å¯¬åº¦ (15æ ¼æ„Ÿ) */
        .search-input { width: 450px; }

        input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        button {
            padding: 12px 24px; font-size: 15px; font-weight: 600; cursor: pointer;
            border-radius: 8px; border: none; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); }
        
        .btn-refresh { background: #64748b; color: white; }
        .btn-refresh:hover { background: #475569; }

        /* è¡¨æ ¼è¨­è¨ˆï¼šç°¡ç´„å¤§æ°£ */
        .table-res { width: 100%; overflow-x: auto; margin-top: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { background: #f8fafc; padding: 14px; font-weight: 600; color: #475569; text-align: left; border-bottom: 2px solid var(--border-color); }
        td { padding: 14px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        tr:hover { background: #f1f5f9; }

        /* ç‰¹æ®Šç‹€æ…‹æ¨™ç±¤åŒ– (å–ä»£æ•´åˆ—è®Šè‰²ï¼Œè¦–è¦ºæ›´ä¹¾æ·¨) */
        .tag { padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 12px; }
        .tag-ev { background: var(--status-green); color: var(--text-green); border: 1px solid #bbf7d0; }
        .tag-dk { background: var(--status-blue); color: var(--text-blue); border: 1px solid #bfdbfe; }

        /* å€å¡ŠäºŒæ¨™ç±¤ */
        .v-yusong { color: var(--text-red); font-weight: bold; }
        .v-speedy { color: var(--text-yellow); font-weight: bold; }
        .v-ching { color: var(--text-green); font-weight: bold; }

        .type-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; }
        .t-pcb { background: var(--status-green); color: var(--text-green); }
        .t-assy { background: var(--status-red); color: var(--text-red); }
        .t-parts { background: var(--status-yellow); color: var(--text-yellow); }
        .t-pcbassy { background: var(--status-blue); color: var(--text-blue); }

        .loading-spinner { display: none; margin-left: 10px; color: var(--primary-color); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>æ½¤é‰‘ PCB æ•´åˆç®¡ç†ç³»çµ±</h2>
        <button class="btn-refresh" onclick="refreshPage()">ğŸ”„ é‡æ–°æ•´ç†</button>
    </div>

    <div class="section">
        <h3>ğŸ“¦ å€å¡Šä¸€ï¼šEVB_List æŸ¥è©¢</h3>
        <div class="controls">
            <input type="text" id="inputEvb" class="search-input" placeholder="è¼¸å…¥ PCB Number (å¦‚: 20602)">
            <button class="btn-primary" onclick="fetchData('evb', 'inputEvb', 'body1')">æœå°‹å°ˆæ¡ˆ</button>
            <span id="load1" class="loading-spinner">æœå°‹ä¸­...</span>
        </div>
        <div class="table-res">
            <table><thead><tr id="head1"></tr></thead><tbody id="body1"></tbody></table>
        </div>
    </div>

    <div class="section">
        <h3>ğŸ“‹ å€å¡ŠäºŒï¼šDUT+PROBE_B æŸ¥è©¢</h3>
        <div class="controls">
            <select id="vendorSelect"><option value="">-- è¼‰å…¥å» å•†ä¸­ --</option></select>
            <button class="btn-primary" onclick="fetchData('dut_vendor', 'vendorSelect', 'body2')">æœå°‹å» å•†</button>
            
            <span style="color: #cbd5e1; margin: 0 10px;">|</span>
            
            <input type="text" id="inputDut" class="search-input" placeholder="æœå°‹ Part Number (å¦‚: 05848)">
            <button class="btn-primary" onclick="fetchData('dut_project', 'inputDut', 'body2')">æœå°‹å°ˆæ¡ˆ</button>
            <span id="load2" class="loading-spinner">æœå°‹ä¸­...</span>
        </div>
        <div class="table-res">
            <table><thead><tr id="head2"></tr></thead><tbody id="body2"></tbody></table>
        </div>
    </div>
</div>

<script>
    const GAS_URL = CONFIG.GAS_URL;

    // é‡æ–°æ•´ç†é é¢
    function refreshPage() {
        window.location.reload();
    }

    // æ¸…é™¤ç‰¹å®šå€å¡Šå…§å®¹
    function clearSection(sectionNum) {
        document.getElementById(`head${sectionNum}`).innerHTML = "";
        document.getElementById(`body${sectionNum}`).innerHTML = "";
        document.getElementById(`load${sectionNum}`).style.display = "none";
    }

    window.onload = async () => {
        try {
            const res = await fetch(`${GAS_URL}?action=get_vendors`);
            const vendors = await res.json();
            const select = document.getElementById('vendorSelect');
            select.innerHTML = '<option value="">è«‹é¸æ“‡å» å•† (Fæ¬„)</option>';
            vendors.forEach(v => { if(v) select.innerHTML += `<option value="${v}">${v}</option>`; });
        } catch (e) { console.error("ç„¡æ³•è¼‰å…¥å» å•†"); }
    };

    async function fetchData(action, inputId, bodyId) {
        const val = document.getElementById(inputId).value;
        const body = document.getElementById(bodyId);
        const head = document.getElementById(bodyId === 'body1' ? 'head1' : 'head2');
        const load = document.getElementById(bodyId === 'body1' ? 'load1' : 'load2');
        
        // æ ¸å¿ƒé‚è¼¯ï¼šæœå°‹ä¸€é‚Šæ™‚ï¼Œæ¸…é™¤å¦ä¸€é‚Š
        if (bodyId === 'body1') clearSection(2);
        else clearSection(1);

        if(!val) return;

        load.style.display = "inline";
        body.innerHTML = "";

        try {
            const res = await fetch(`${GAS_URL}?key=${encodeURIComponent(val)}&action=${action}`);
            const data = await res.json();
            load.style.display = "none";

            if (data.length === 0) {
                body.innerHTML = "<tr><td colspan='20'>ç„¡ç¬¦åˆè³‡æ–™</td></tr>";
                return;
            }

            const headers = Object.keys(data[0]);
            head.innerHTML = headers.map(h => `<th>${h}</th>`).join('');

            data.forEach(item => {
                const tr = document.createElement('tr');
                headers.forEach((h, idx) => {
                    const td = document.createElement('td');
                    let text = item[h];

                    // é‡‘é¡æ ¼å¼åŒ–
                    if (idx === 6 && !isNaN(text) && text !== "") text = Number(text).toLocaleString();

                    // è¦–è¦ºå„ªåŒ–ï¼šå°‡ç‰¹å®šæ–‡å­—è½‰ç‚ºæ¨™ç±¤
                    if (bodyId === 'body1' && idx === 2) {
                        const type = String(text).toUpperCase().startsWith("EV") ? "EV" : "DK";
                        td.innerHTML = `<span class="tag tag-${type.toLowerCase()}">${text}</span>`;
                    } else if (bodyId === 'body2') {
                        // Fæ¬„ å» å•†é¡è‰²æ–‡å­— (idx 5)
                        const v = String(item[headers[5]] || "").toUpperCase();
                        if (v.includes("YUSONG")) td.classList.add('v-yusong');
                        else if (v.includes("SPEEDY")) td.classList.add('v-speedy');
                        else if (v.includes("CHING DENG")) td.classList.add('v-ching');

                        // Eæ¬„ é¡å‹è½‰ Badge (idx 4)
                        if (idx === 4) {
                            const t = String(text).toUpperCase().replace("+", "");
                            td.innerHTML = `<span class="type-badge t-${t.toLowerCase()}">${text}</span>`;
                        } else {
                            td.innerText = text || "";
                        }
                    } else {
                        td.innerText = text || "";
                    }
                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });
        } catch (e) { load.innerText = "æœå°‹å¤±æ•—"; }
    }
</script>
</body>
</html>
