<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mouser BOM ç”¢ç”Ÿå™¨ V2</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f6f9; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { color: #0046ad; border-bottom: 2px solid #0046ad; padding-bottom: 10px; }
        
        .step-box { margin-bottom: 25px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px; background-color: #fafafa; }
        .step-title { font-weight: bold; margin-bottom: 10px; display: block; color: #333; }
        
        input[type="text"], input[type="number"], select { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; }
        input[type="file"] { margin-top: 5px; }
        
        .row-inputs { display: flex; gap: 15px; }
        .half-width { flex: 1; }

        button { padding: 10px 20px; background-color: #0046ad; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        button:hover { background-color: #003380; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        #step2, #step3 { display: none; } /* åˆå§‹éš±è— */
        #status { margin-top: 15px; font-weight: bold; color: green; }
        .file-info { font-size: 0.9em; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ› ï¸ BOM è½‰ Mouser è¨‚å–®å·¥å…·</h2>

    <div class="step-box" id="step1">
        <span class="step-title">æ­¥é©Ÿ 1: ä¸Šå‚³èˆ‡è¨­å®š</span>
        
        <label>1. é¸æ“‡åŸå§‹ BOM (Excel):</label>
        <input type="file" id="upload" accept=".xlsx, .xls" />
        
        <div style="margin-top: 15px;">
            <label>2. è³‡æ–™æ¨™é¡Œåœ¨ç¬¬å¹¾åˆ—? (ä¾‹å¦‚æ‚¨çš„æª”æ¡ˆæ˜¯ç¬¬ 8 åˆ—)</label>
            <input type="number" id="headerRowIndex" value="1" min="1" placeholder="è¼¸å…¥åˆ—è™Ÿ" />
        </div>

        <button onclick="analyzeFile()">è®€å–ä¸¦åˆ†ææ¬„ä½</button>
    </div>

    <div class="step-box" id="step2">
        <span class="step-title">æ­¥é©Ÿ 2: æ¬„ä½å°æ‡‰èˆ‡å°ˆæ¡ˆè¨­å®š</span>
        
        <div class="file-info">å·²è®€å–æª”æ¡ˆ: <span id="fileNameDisplay" style="color:#0046ad; font-weight:bold;"></span></div>

        <div class="row-inputs">
            <div class="half-width">
                <label>å°ˆæ¡ˆåç¨± (å­˜æª”ç”¨):</label>
                <input type="text" id="projectName" placeholder="ä¾‹å¦‚: Project_A" />
            </div>
            <div class="half-width">
                <label>é è¨ˆè£½ä½œå¥—æ•¸ (ä¹˜æ•¸):</label>
                <input type="number" id="batchSize" value="1" min="1" />
                <small style="color:gray;">* è¼¸å‡ºæ•¸é‡ = åŸå§‹æ•¸é‡ x å¥—æ•¸</small>
            </div>
        </div>
        <br>

        <label>è«‹é¸æ“‡å°æ‡‰çš„æ¬„ä½:</label>
        <div class="row-inputs">
            <div class="half-width">
                <label for="colPart">åŸå» æ–™è™Ÿ (Manufacturer PN):</label>
                <select id="colPart"></select>
            </div>
            <div class="half-width">
                <label for="colQty">åŸå§‹æ•¸é‡ (Quantity):</label>
                <select id="colQty"></select>
            </div>
        </div>

        <br>
        <button onclick="generateMouserBOM()">ç”¢ç”Ÿä¸¦ä¸‹è¼‰ Mouser BOM</button>
    </div>

    <div id="status"></div>
</div>

<script>
    let globalData = [];
    let workbook = null;

    function analyzeFile() {
        const fileInput = document.getElementById('upload');
        const headerRowVal = parseInt(document.getElementById('headerRowIndex').value);

        if (fileInput.files.length === 0) {
            alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼");
            return;
        }
        if (isNaN(headerRowVal) || headerRowVal < 1) {
            alert("è«‹è¼¸å…¥æ­£ç¢ºçš„åˆ—è™Ÿ (å¤§æ–¼ 0)");
            return;
        }

        const file = fileInput.files[0];
        // é¡¯ç¤ºæª”å
        document.getElementById('fileNameDisplay').innerText = file.name;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            workbook = XLSX.read(data, { type: 'array' });
            
            // è®€å–ç¬¬ä¸€å€‹ Sheet
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // è½‰æˆ Array of Arrays (åŒ…å«æ‰€æœ‰è³‡æ–™)
            globalData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // å‘¼å«è™•ç†å‡½å¼ï¼Œå‚³å…¥ä½¿ç”¨è€…æŒ‡å®šçš„ã€Œç¬¬å¹¾åˆ—ã€ (è½‰æˆ index è¦ -1)
            populateSelectOptions(headerRowVal - 1);
        };
        reader.readAsArrayBuffer(file);
    }

    function populateSelectOptions(headerIndex) {
        if (headerIndex >= globalData.length) {
            alert("éŒ¯èª¤ï¼šæ‚¨æŒ‡å®šçš„åˆ—è™Ÿè¶…éäº†æª”æ¡ˆçš„ç¸½è¡Œæ•¸ã€‚");
            return;
        }

        const headers = globalData[headerIndex];
        const partSelect = document.getElementById('colPart');
        const qtySelect = document.getElementById('colQty');

        // æ¸…ç©ºé¸å–®
        partSelect.innerHTML = "";
        qtySelect.innerHTML = "";

        let foundPart = false;
        let foundQty = false;

        // å¡«å……ä¸‹æ‹‰é¸å–®
        headers.forEach((header, index) => {
            if(!header) return; // è·³éç©ºæ¬„ä½
            
            const option1 = document.createElement("option");
            option1.value = index;
            option1.text = `[æ¬„ ${index+1}] ${header}`;
            partSelect.appendChild(option1);

            const option2 = document.createElement("option");
            option2.value = index;
            option2.text = `[æ¬„ ${index+1}] ${header}`;
            qtySelect.appendChild(option2);

            // ç°¡å–®çš„è‡ªå‹•åµæ¸¬ (å¹«åŠ©ä½¿ç”¨è€…é é¸)
            const h = String(header).toLowerCase();
            if ((h.includes("part") || h.includes("pn") || h.includes("æ–™è™Ÿ")) && !foundPart) {
                partSelect.selectedIndex = partSelect.options.length - 1;
                foundPart = true; // é¿å…é‡è¤‡é¸
            }
            if ((h.includes("qty") || h.includes("quantity") || h.includes("æ•¸é‡")) && !foundQty) {
                qtySelect.selectedIndex = qtySelect.options.length - 1;
                foundQty = true;
            }
        });

        // é¡¯ç¤ºæ­¥é©Ÿ 2
        document.getElementById('step1').style.opacity = "0.5"; // è®“æ­¥é©Ÿ1è®Šæ·¡
        document.getElementById('step2').style.display = "block";
    }

    function generateMouserBOM() {
        const headerRowVal = parseInt(document.getElementById('headerRowIndex').value);
        const headerIndex = headerRowVal - 1;
        
        const partColIndex = parseInt(document.getElementById('colPart').value);
        const qtyColIndex = parseInt(document.getElementById('colQty').value);
        
        const batchSize = parseInt(document.getElementById('batchSize').value) || 1;
        const projectName = document.getElementById('projectName').value.trim() || "MyProject";

        let outputData = [];
        // Mouser æ¨™æº–æ¨™é¡Œ
        outputData.push(["Mfr Part Number", "Order Quantity", "Customer Reference"]);

        // å¾æ¨™é¡Œåˆ—çš„ä¸‹ä¸€åˆ—é–‹å§‹è·‘è¿´åœˆ
        for (let i = headerIndex + 1; i < globalData.length; i++) {
            const row = globalData[i];
            
            // å–å¾—æ–™è™Ÿèˆ‡æ•¸é‡
            const rawPart = row[partColIndex];
            let rawQty = row[qtyColIndex];

            // è‹¥æ–™è™Ÿç‚ºç©ºï¼Œè·³éæ­¤è¡Œ
            if (!rawPart) continue;

            // è™•ç†æ•¸é‡ (è½‰æˆæ•¸å­—ï¼Œè‹¥éæ•¸å­—å‰‡é è¨­ç‚º 0)
            let baseQty = parseFloat(rawQty);
            if (isNaN(baseQty)) baseQty = 0;

            // è¨ˆç®—ç¸½è¨‚è³¼é‡
            const orderQty = baseQty * batchSize;

            if (orderQty > 0) {
                outputData.push([rawPart, orderQty, projectName]); // ç¬¬ä¸‰æ¬„å¯æ”¾å°ˆæ¡ˆåç•¶å‚™è¨»
            }
        }

        // åŒ¯å‡ºæª”æ¡ˆ
        const newWs = XLSX.utils.aoa_to_sheet(outputData);
        const newWb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWb, newWs, "Mouser_Upload");

        const fileName = `${projectName}_Mouser_BOM.xlsx`;
        XLSX.writeFile(newWb, fileName);

        document.getElementById('status').innerText = `âœ… å·²æˆåŠŸä¸‹è¼‰: ${fileName} (åŒ…å« ${outputData.length - 1} ç­†è³‡æ–™)`;
    }
</script>

</body>
</html>
