<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOM 旗艦備料系統 V1.4 (關鍵字鬆綁版)</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0046ad; --digikey: #cc0000; --elem14: #ff6600; --light: #f4f6f9; --border: #e0e0e0; --success: #28a745; --info: #17a2b8; --purple: #6f42c1; --danger: #dc3545; }
        
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background-color: var(--light); margin: 0; padding: 20px; color: #333; font-size: 16px; }
        
        .container { max-width: 95%; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); overflow: hidden; min-width: 1000px; }
        
        .stepper { display: flex; justify-content: space-between; padding: 25px 50px; background: #fafafa; border-bottom: 1px solid var(--border); }
        .step { text-align: center; flex: 1; opacity: 0.5; font-weight: bold; font-size: 1.1em; }
        .step.active { opacity: 1; color: var(--primary); }
        .step i { display: block; font-size: 28px; margin-bottom: 8px; }

        .step-content { display: none; padding: 40px; }
        .step-content.active { display: block; }

        .upload-zone { border: 3px dashed #aaa; border-radius: 10px; padding: 80px; text-align: center; cursor: pointer; transition: 0.3s; background: #fff; }
        .upload-zone:hover { border-color: var(--primary); background-color: #f0f7ff; }

        .settings-panel { display: flex; gap: 20px; margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #eee; }
        .setting-item { flex: 1; }
        .setting-item label { font-weight: bold; display: block; margin-bottom: 8px; font-size: 1rem; color: #555; }
        .setting-item input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; font-weight: bold; }
        .input-group { position: relative; }
        .input-group i { position: absolute; right: 10px; top: 12px; color: #aaa; }

        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .selection-tools button { font-size: 1rem; padding: 8px 15px; cursor: pointer; border: 1px solid #ccc; background: white; border-radius: 4px; margin-right: 8px; }
        .selection-tools button:hover { background: #eee; }

        .table-container { min-height: 400px; border: 1px solid #eee; border-radius: 4px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 1rem; }
        th { background: #eaeaea; padding: 15px; text-align: left; border-bottom: 2px solid #ccc; font-size: 1.05rem; white-space: nowrap; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background-color: #f9f9f9; }
        tr.excluded { background-color: #ffeef0; color: #aaa; text-decoration: line-through; }
        tr.selected { background-color: #e3f2fd; }

        .badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.9em; display: inline-block; white-space: nowrap; }
        .badge-smt { color: #0056b3; background: #dbeafe; border: 1px solid #b3d7ff; }
        .badge-gen { color: #5a32a3; background: #e9dffc; border: 1px solid #d1c4e9; }
        .badge-del { color: var(--danger); font-style: italic; }
        .badge-nm { color: #856404; background-color: #fff3cd; border: 1px solid #ffeeba; }
        .badge-consigned { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .badge-pcb { color: #343a40; background-color: #e2e3e5; border: 1px solid #d6d8db; }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 20px; padding: 10px; background: #fafafa; border-radius: 8px; }
        .page-btn { padding: 8px 16px; border: 1px solid #ccc; background: white; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn:hover:not(:disabled) { background: #e0e0e0; }
        .page-info { font-weight: bold; color: #555; }

        .export-panel { margin-top: 30px; padding: 25px; background: #f1f3f5; border-radius: 8px; border: 1px solid #ddd; }
        .btn-group { display: flex; gap: 20px; margin-top: 15px; }
        .btn { padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1rem; font-weight: bold; color: white; flex: 1; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-mouser { background: var(--primary); }
        .btn-mouser:hover { background: #003380; transform: translateY(-2px); }
        .btn-digikey { background: var(--digikey); }
        .btn-digikey:hover { background: #990000; transform: translateY(-2px); }
        .btn-elem14 { background: var(--elem14); }
        .btn-elem14:hover { background: #cc5200; transform: translateY(-2px); }
    </style>
</head>
<body>

<div class="container">
    <div class="stepper">
        <div class="step active" id="nav-step1"><i class="fas fa-file-upload"></i> 1. 上傳原始 BOM</div>
        <div class="step" id="nav-step2"><i class="fas fa-microchip"></i> 2. 智慧雙重備料</div>
    </div>

    <div id="step1" class="step-content active">
        <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-robot" style="font-size: 80px; color: #0046ad; margin-bottom: 25px;"></i>
            <h3>拖曳或點擊上傳 BOM</h3>
            <p style="color: #666; font-size: 1.1rem;">僅支援 .xlsx / .xls / .csv 格式<br>機構件(Screw/Standoff)不在此限</p>
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="display: none;" onchange="handleFile(this.files[0])" />
        </div>
    </div>

    <div id="step2" class="step-content">
        <div class="settings-panel">
            <div class="setting-item" style="flex: 2;">
                <label>專案名稱 (自動年份):</label>
                <div class="input-group">
                    <input type="text" id="projectName">
                    <i class="fas fa-pen"></i>
                </div>
            </div>
            <div class="setting-item">
                <label>製作套數 (Batch):</label>
                <input type="number" id="batchSize" value="1" min="1" onchange="recalcAndRender()">
            </div>
            <div class="setting-item" style="background: #e3f2fd; border-radius: 4px; padding: 5px 10px; border: 1px solid #b3d7ff;">
                <label style="color:#0046ad;">SMT 拋料 (R/C/D):</label>
                <input type="number" id="smtBuffer" value="20" min="0" onchange="recalcAndRender()" style="color:#0046ad;">
            </div>
            <div class="setting-item" style="background: #f3e5f5; border-radius: 4px; padding: 5px 10px; border: 1px solid #e1bee7;">
                <label style="color:#4a148c;">其他備用 (IC/Conn):</label>
                <input type="number" id="genBuffer" value="1" min="0" onchange="recalcAndRender()" style="color:#4a148c;">
            </div>
        </div>

        <div class="toolbar">
            <div class="selection-tools">
                <button onclick="selectAll(true)">全選</button>
                <button onclick="selectAll(false)">全不選</button>
                <button onclick="invertSelection()" style="background: #fff8e1; border-color: #ffc107; color: #856404;">
                    <i class="fas fa-exchange-alt"></i> 反向選取
                </button>
            </div>
            <div id="selectionStats" style="font-weight: bold; color: var(--primary); font-size: 1.1rem;">已選: 0</div>
        </div>

        <div class="table-container">
            <table id="previewTable">
                <thead>
                    <tr>
                        <th width="40"><input type="checkbox" id="masterCheck" onchange="selectAll(this.checked)"></th>
                        <th width="50">Item</th>
                        <th width="100">Part Ref <br><span style="color:#888;font-weight:normal;font-size:0.8em">(縮略)</span></th>
                        <th>Description</th>
                        <th>MPN (料號)</th>
                        <th width="70">單量</th>
                        <th width="90">總量(含備)</th>
                        <th width="180">狀態</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="pagination" id="paginationControls">
            <button class="page-btn" onclick="changePage(-1)" id="btnPrev">❮ 上一頁</button>
            <span class="page-info" id="pageInfo">Page 1 of 1</span>
            <button class="page-btn" onclick="changePage(1)" id="btnNext">下一頁 ❯</button>
        </div>

        <div class="export-panel">
            <span style="font-weight:bold; font-size: 1.1rem;"><i class="fas fa-file-export"></i> 匯出 (14pt粗體表頭 + 置中):</span>
            <div class="btn-group">
                <button class="btn btn-mouser" onclick="exportUniversalBOM('Mouser')">Mouser</button>
                <button class="btn btn-digikey" onclick="exportUniversalBOM('Digikey')">DigiKey</button>
                <button class="btn btn-elem14" onclick="exportUniversalBOM('Elem14')">Element14</button>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="location.reload()" style="background:none; border:none; color: #666; cursor:pointer; text-decoration: underline; font-size: 1rem;">處理新檔案</button>
        </div>
    </div>
</div>

<script>
    let rawData = [];
    let tableRows = []; 
    let colMap = { item: -1, mfr: -1, part: -1, part_backup: -1, qty: -1, ref: -1, desc: -1 };
    let currentPage = 1;
    const itemsPerPage = 50;

    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });

    function handleFile(file) {
        if (!file) return;

        const fileName = file.name.toLowerCase();
        const validExtensions = ['.xlsx', '.xls', '.csv'];
        const isValid = validExtensions.some(ext => fileName.endsWith(ext));

        if (!isValid) {
            alert("❌ 檔案格式錯誤！\n\n系統僅支援下列格式：\n• Excel (.xlsx, .xls)\n• CSV (.csv)\n\n(若是 Google Sheet，請先下載為 Excel 檔案)");
            return;
        }
        
        const now = new Date();
        const yearSuffix = String(now.getFullYear()).slice(-2);
        const baseName = file.name.replace(/\.[^/.]+$/, ""); 
        document.getElementById('projectName').value = `A${yearSuffix}_xxx_${baseName}`;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            analyzeData();
        };
        reader.readAsArrayBuffer(file);
    }

    function analyzeData() {
        let bestHeaderRow = -1;
        let maxScore = 0;
        
        for (let i = 0; i < Math.min(rawData.length, 25); i++) {
            let score = 0;
            const rowStr = rawData[i].map(c => String(c).toLowerCase().trim()).join(" ");
            
            if (rowStr.includes("item") || rowStr.includes("no.")) score += 2;
            if (rowStr.includes("qty") || rowStr.includes("quantity")) score += 3;
            if (rowStr.includes("description") || rowStr.includes("desc")) score += 2;
            if (rowStr.includes("part") || rowStr.includes("pn") || rowStr.includes("mpn") || rowStr.includes("料號")) score += 3;
            if (rowStr.includes("manufacturer") || rowStr.includes("mfr")) score += 2;
            if (rowStr.includes("reference") || rowStr.includes("ref")) score += 2;

            if (score > maxScore) { maxScore = score; bestHeaderRow = i; }
        }

        if (bestHeaderRow === -1 || maxScore < 4) {
            bestHeaderRow = 7; 
            colMap = { item: 0, qty: 2, ref: 3, desc: 4, mfr: 5, part: 6, part_backup: -1 };
        } else {
            colMap = { item: -1, mfr: -1, part: -1, part_backup: -1, qty: -1, ref: -1, desc: -1 };
            let possiblePartIdx = -1; 
            let definitiveMpnFound = false;

            rawData[bestHeaderRow].forEach((cell, idx) => {
                const c = String(cell).toLowerCase().trim();
                if (c === "item" || c === "item number" || c === "no.") colMap.item = idx;
                else if (c === "quantity" || c === "qty") colMap.qty = idx;
                else if (c.includes("reference") || c.includes("ref") || c.includes("designator")) colMap.ref = idx;
                else if ((c.includes("manufacturer") || c.includes("mfr")) && !c.includes("pn") && !c.includes("part") && !c.includes("number")) {
                    colMap.mfr = idx;
                }
                else if (c.includes("description") || c === "desc") {
                    colMap.desc = idx;
                }
                else if (c === "mpn" || c.includes("mfr p/n") || c.includes("manufacturer's part") || c.includes("manufacturer part number") || c.includes("manufacturer pn")) {
                    colMap.part = idx;
                    definitiveMpnFound = true;
                }
                else if (c === "part" || c === "part number" || c === "part_number" || c === "p/n") {
                    possiblePartIdx = idx;
                }
            });

            if (definitiveMpnFound) {
                if (colMap.desc === -1 && possiblePartIdx !== -1) colMap.desc = possiblePartIdx;
                if (possiblePartIdx !== -1) colMap.part_backup = possiblePartIdx;
            } else {
                if (colMap.part === -1 && possiblePartIdx !== -1) colMap.part = possiblePartIdx;
            }
            if (colMap.part === -1 && colMap.mfr !== -1) colMap.part = colMap.mfr + 1;
        }

        processTableData(bestHeaderRow);
    }

    // ★★★ V1.4 修正：關鍵字鬆綁 (移除 SCREW, NUT, STANDOFF) ★★★
    function processTableData(headerRowIndex) {
        tableRows = [];
        
        // 修正後的關鍵字清單：移除了機構件，保留真正的 DNP 關鍵字
        const excludeKeywords = ["TDK-INVENSENSE", "NO-LOAD", "DNP", "UNUSED", "DO NOT STUFF"];
        const pcbKeywords = ["PCB FAB", "BARE BOARD", "PRINTED CIRCUIT BOARD"];
        
        const passiveMfrs = ["YAGEO", "TDK", "MURATA", "SAMSUNG", "KEMET", "AVX", "KYOCERA", "WALSIN", "TAIYO", "VISHAY", "PANASONIC", "ROHM", "BOURNS"];
        const capUnits = ["UF", "PF", "NF", "µF"];
        const resUnits = ["OHM", "Ω", " KOHM", " MOHM", " 1%"];
        const consignedMpns = ["QSS-100-01-F-D-A", "QTS-100-01-F-D-A", "QTH-120-01-F-D-A", "QSH-120-01-F-D-A"];

        let notMountMode = false;

        for (let i = headerRowIndex + 1; i < rawData.length; i++) {
            const row = rawData[i];
            const rowStrAll = row.map(c => String(c)).join(" ").toUpperCase();
            
            const qtyVal = parseFloat(colMap.qty !== -1 ? row[colMap.qty] : 0) || 0;

            // 1. Not Mount 區段偵測 (嚴格模式：必須有 NOT MOUNT:)
            if (rowStrAll.includes("NOT MOUNT:")) {
                notMountMode = true;
                continue; 
            }
            
            const itemVal = colMap.item !== -1 ? (row[colMap.item] || (i - headerRowIndex)) : (i - headerRowIndex);
            const mfrVal = colMap.mfr !== -1 ? (row[colMap.mfr] || "") : "";
            
            let partVal = colMap.part !== -1 ? (row[colMap.part] || "") : "";
            if (!partVal && colMap.part_backup !== -1) {
                partVal = row[colMap.part_backup] || "";
            }

            const refVal = colMap.ref !== -1 ? String(row[colMap.ref] || "").trim().toUpperCase() : "";
            const descVal = colMap.desc !== -1 ? String(row[colMap.desc] || "").trim().toUpperCase() : "";

            if (!partVal && qtyVal === 0) continue; 
            if (String(partVal).toUpperCase().includes("NOTE")) continue;

            let isExcluded = false;
            let excludeReason = "";

            // A. Not Mount 區塊
            if (notMountMode) {
                isExcluded = true;
                excludeReason = "Not Mount (不上件區)";
            }
            // B. PCB過濾
            else if (pcbKeywords.some(k => rowStrAll.includes(k)) || descVal === "PCB" || descVal.startsWith("PCB ")) {
                 isExcluded = true;
                 excludeReason = "PCB過濾";
            }
            // C. Samtec 客戶提供
            else if (String(mfrVal).toUpperCase().includes("SAMTEC") && consignedMpns.includes(String(partVal).toUpperCase().trim())) {
                isExcluded = true;
                excludeReason = "客戶提供";
            }
            // D. 單行關鍵字過濾 (這裡現在只會抓到 DNP/No-Load, 不會抓 SCREW 了)
            else if (excludeKeywords.some(k => rowStrAll.includes(k))) {
                isExcluded = true;
                if (rowStrAll.includes("NO-LOAD") || rowStrAll.includes("DNP") || rowStrAll.includes("UNUSED") || rowStrAll.includes("DO NOT STUFF")) {
                    excludeReason = "No-Load (不上件)";
                } else {
                    excludeReason = "自動過濾";
                }
            }
            
            let isSmtPart = false;
            if (!isExcluded) {
                if (refVal.startsWith("R") && !refVal.startsWith("RP") && !refVal.startsWith("REG")) {
                     if (descVal.includes("RES") || descVal.includes("OHM") || resUnits.some(u => descVal.includes(u))) isSmtPart = true;
                     else if (passiveMfrs.some(m => String(mfrVal).toUpperCase().includes(m))) isSmtPart = true;
                }
                else if (refVal.startsWith("C") && !refVal.startsWith("CN") && !refVal.startsWith("CON")) {
                     if (descVal.includes("CAP") || descVal.includes("CER") || capUnits.some(u => descVal.includes(u))) isSmtPart = true;
                     else if (passiveMfrs.some(m => String(mfrVal).toUpperCase().includes(m))) isSmtPart = true;
                }
                else if (refVal.startsWith("D") || refVal.startsWith("LED")) {
                     if (descVal.includes("LED") || descVal.includes("DIODE")) isSmtPart = true;
                }
                else if (refVal.startsWith("RP")) {
                     if (descVal.includes("RES") || descVal.includes("ARRAY")) isSmtPart = true;
                }
            }

            tableRows.push({ 
                id: i, item: itemVal, mfr: mfrVal, part: partVal, qty: qtyVal, 
                ref: refVal, desc: descVal, 
                checked: !isExcluded, excluded: isExcluded, excludeReason: excludeReason,
                isSmtPart: isSmtPart
            });
        }
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step2').classList.add('active');
        document.getElementById('nav-step2').classList.add('active');
        currentPage = 1;
        recalcAndRender();
    }

    function recalcAndRender() {
        const batchSize = parseInt(document.getElementById('batchSize').value) || 1;
        const smtBuffer = parseInt(document.getElementById('smtBuffer').value) || 0;
        const genBuffer = parseInt(document.getElementById('genBuffer').value) || 0;
        tableRows.forEach(r => {
            let baseQty = r.qty * batchSize;
            if (r.excluded) r.finalQty = baseQty;
            else {
                if (r.isSmtPart) { r.finalQty = baseQty + smtBuffer; r.statusType = 'smt'; }
                else { r.finalQty = baseQty + genBuffer; r.statusType = 'gen'; }
            }
        });
        updateStats();
        renderPage(); 
    }

    function renderPage() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageData = tableRows.slice(start, end);

        pageData.forEach(r => {
            const tr = document.createElement('tr');
            tr.id = `row-${r.id}`;
            if (r.excluded) tr.className = 'excluded';
            else if (r.checked) tr.classList.add('selected');

            let displayRef = r.ref;
            const splitRef = r.ref.split(/[\s,]+/); 
            const validRef = splitRef.filter(s => s.length > 0)[0];
            if(validRef && splitRef.length > 1) displayRef = validRef + "...";

            let statusHtml = "";
            if (r.excluded) {
                if (r.excludeReason.includes("Not Mount") || r.excludeReason.includes("No-Load")) {
                     statusHtml = `<span class="badge badge-nm"><i class="fas fa-ban"></i> ⛔ ${r.excludeReason}</span>`;
                } else if (r.excludeReason === "客戶提供") {
                     statusHtml = `<span class="badge badge-consigned"><i class="fas fa-hand-holding"></i> ⛔ 客戶提供</span>`;
                } else if (r.excludeReason === "PCB過濾") {
                     statusHtml = `<span class="badge badge-pcb"><i class="fas fa-layer-group"></i> ⛔ PCB過濾</span>`;
                } else {
                     statusHtml = `<span class="badge badge-del">${r.excludeReason}</span>`;
                }
            } else {
                if (r.statusType === 'smt') statusHtml = `<span class="badge badge-smt"><i class="fas fa-magic"></i> OK (SMT拋料)</span>`;
                else statusHtml = `<span class="badge badge-gen"><i class="fas fa-box-open"></i> OK (一般備品)</span>`;
            }

            tr.innerHTML = `
                <td><input type="checkbox" onchange="updateRow(${r.id}, this.checked)" ${r.checked ? 'checked' : ''} ${r.excluded ? 'disabled' : ''}></td>
                <td>${r.item}</td>
                <td style="color:#666; font-weight:bold;">${displayRef}</td>
                <td style="color:#444;">${r.desc}</td>
                <td style="font-weight:bold; color:var(--primary);">${r.part}</td>
                <td>${r.qty}</td>
                <td style="font-weight:bold; font-size:1.1em;">${r.finalQty}</td>
                <td>${statusHtml}</td>
            `;
            tbody.appendChild(tr);
        });
        updatePaginationControls();
    }

    function updatePaginationControls() {
        const totalPages = Math.ceil(tableRows.length / itemsPerPage);
        document.getElementById('pageInfo').innerText = `Page ${currentPage} of ${totalPages} (Total ${tableRows.length})`;
        document.getElementById('btnPrev').disabled = (currentPage === 1);
        document.getElementById('btnNext').disabled = (currentPage === totalPages || totalPages === 0);
    }
    function changePage(delta) {
        const totalPages = Math.ceil(tableRows.length / itemsPerPage);
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) { currentPage = newPage; renderPage(); document.querySelector('.table-container').scrollTop = 0; }
    }
    function updateRow(id, checked) {
        const row = tableRows.find(r => r.id === id);
        if (row) {
            row.checked = checked;
            const tr = document.getElementById(`row-${id}`);
            if (tr) { if (checked) tr.classList.add('selected'); else tr.classList.remove('selected'); }
            updateStats();
        }
    }
    function selectAll(checked) {
        document.getElementById('masterCheck').checked = checked;
        tableRows.forEach(r => { if (!r.excluded) r.checked = checked; });
        recalcAndRender();
    }
    function invertSelection() {
        tableRows.forEach(r => { if (!r.excluded) r.checked = !r.checked; });
        recalcAndRender();
    }
    function updateStats() {
        const count = tableRows.filter(r => r.checked).length;
        document.getElementById('selectionStats').innerText = `已選: ${count} 筆`;
    }

    function exportUniversalBOM(platform) {
        const projectName = document.getElementById('projectName').value;
        const selectedRows = tableRows.filter(r => r.checked && r.part);

        if (selectedRows.length === 0) { alert("沒有勾選任何項目！"); return; }

        let outputData = [];
        outputData.push(["Item Number", "Manufacturer Name", "Manufacturer Part Number", "Quantity 1"]);

        selectedRows.forEach(r => {
            outputData.push([r.item, r.mfr, r.part, r.finalQty]);
        });

        const ws = XLSX.utils.aoa_to_sheet(outputData);
        const colWidths = outputData[0].map((_, i) => {
             let max = 15; 
             outputData.forEach(r => { if(r[i] && String(r[i]).length > max) max = String(r[i]).length; });
             return { wch: max + 2 };
        });
        ws['!cols'] = colWidths;

        const range = XLSX.utils.decode_range(ws['!ref']);
        const headerStyle = {
            font: { bold: true, sz: 14 },
            alignment: { horizontal: "center", vertical: "center" }
        };
        const cellStyle = {
            alignment: { horizontal: "center", vertical: "center" }
        };

        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cell_address = XLSX.utils.encode_cell({r: R, c: C});
                if (!ws[cell_address]) continue;
                if (R === 0) ws[cell_address].s = headerStyle;
                else ws[cell_address].s = cellStyle;
            }
        }

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "BOM");

        let suffix = "";
        if(platform === 'Mouser') suffix = "_Mouser";
        else if(platform === 'Digikey') suffix = "_Digikey";
        else if(platform === 'Elem14') suffix = "_Elem14";

        const fileName = `${projectName}${suffix}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }
</script>

</body>
</html>
