<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mouser BOM è½‰æ›å™¨ V3 (Templateç‰ˆ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f6f9; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { color: #0046ad; border-bottom: 2px solid #0046ad; padding-bottom: 10px; }
        .step-box { margin-bottom: 25px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px; background-color: #fafafa; }
        .step-title { font-weight: bold; margin-bottom: 10px; display: block; color: #333; }
        input, select { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .row-inputs { display: flex; gap: 15px; }
        .half-width { flex: 1; }
        button { padding: 10px 20px; background-color: #0046ad; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        button:hover { background-color: #003380; }
        #step2 { display: none; }
        #status { margin-top: 15px; font-weight: bold; color: green; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ› ï¸ BOM è½‰ Mouser è¨‚å–®å·¥å…· (V3)</h2>

    <div class="step-box" id="step1">
        <span class="step-title">æ­¥é©Ÿ 1: ä¸Šå‚³åŸå§‹ BOM</span>
        <input type="file" id="upload" accept=".xlsx, .xls" />
        <div style="margin-top: 10px;">
            <label>è³‡æ–™æ¨™é¡Œåœ¨ç¬¬å¹¾åˆ—? (æ‚¨çš„æª”æ¡ˆæ˜¯ç¬¬ 8 åˆ—)</label>
            <input type="number" id="headerRowIndex" value="1" min="1" />
        </div>
        <button onclick="analyzeFile()">è®€å–æª”æ¡ˆ</button>
    </div>

    <div class="step-box" id="step2">
        <span class="step-title">æ­¥é©Ÿ 2: è¨­å®šèˆ‡è¼¸å‡º</span>
        <div class="row-inputs">
            <div class="half-width">
                <label>å°ˆæ¡ˆåç¨± (æª”åç”¨):</label>
                <input type="text" id="projectName" placeholder="Project_Name" />
            </div>
            <div class="half-width">
                <label>è£½ä½œå¥—æ•¸ (ä¹˜æ•¸):</label>
                <input type="number" id="batchSize" value="1" min="1" />
            </div>
        </div>
        <br>
        <label>è«‹å°æ‡‰åŸå§‹æ¬„ä½:</label>
        <div class="row-inputs">
            <div class="half-width">
                <label>åŸå» æ–™è™Ÿ (å°æ‡‰åˆ° Mouser Bæ¬„):</label>
                <select id="colPart"></select>
            </div>
            <div class="half-width">
                <label>åŸå§‹æ•¸é‡ (å°æ‡‰åˆ° Mouser Fæ¬„):</label>
                <select id="colQty"></select>
            </div>
        </div>
        <br>
        <button onclick="generateMouserBOM()">ä¸‹è¼‰ Mouser æ ¼å¼ Excel</button>
    </div>

    <div id="status"></div>
</div>

<script>
    let globalData = [];
    let workbook = null;

    function analyzeFile() {
        const fileInput = document.getElementById('upload');
        const headerRowVal = parseInt(document.getElementById('headerRowIndex').value);
        if (fileInput.files.length === 0) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼"); return; }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            workbook = XLSX.read(data, { type: 'array' });
            globalData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            populateSelectOptions(headerRowVal - 1);
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
    }

    function populateSelectOptions(headerIndex) {
        if (headerIndex >= globalData.length) return alert("åˆ—è™ŸéŒ¯èª¤");
        const headers = globalData[headerIndex];
        const partSelect = document.getElementById('colPart');
        const qtySelect = document.getElementById('colQty');
        partSelect.innerHTML = qtySelect.innerHTML = "";

        headers.forEach((h, i) => {
            if(!h) return;
            let text = `[æ¬„ ${i+1}] ${h}`;
            partSelect.add(new Option(text, i));
            qtySelect.add(new Option(text, i));
        });

        // æ™ºæ…§é é¸
        const partIdx = headers.findIndex(h => /part|pn|æ–™è™Ÿ/i.test(String(h)));
        const qtyIdx = headers.findIndex(h => /qty|quantity|æ•¸é‡/i.test(String(h)));
        if(partIdx > -1) partSelect.value = partIdx;
        if(qtyIdx > -1) qtySelect.value = qtyIdx;

        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'block';
    }

    function generateMouserBOM() {
        const headerRowVal = parseInt(document.getElementById('headerRowIndex').value);
        const partCol = parseInt(document.getElementById('colPart').value);
        const qtyCol = parseInt(document.getElementById('colQty').value);
        const batchSize = parseInt(document.getElementById('batchSize').value) || 1;
        const projectName = document.getElementById('projectName').value.trim() || "MyProject";

        let outputData = [];
        
        // --- è¨­å®š Mouser Template æ¨™é ­ (æ¨¡æ“¬æ‚¨æä¾›çš„ BomTemplate.xls) ---
        // A=0, B=1, C=2, D=3, E=4, F=5
        outputData.push([
            "Mfr Part Number (Input)", // A
            "Manufacturer Part Number",// B (é‡é»)
            "Mouser Part Number",      // C
            "Manufacturer Name",       // D
            "Description",             // E
            "Quantity 1"               // F (é‡é»)
        ]);

        for (let i = headerRowVal; i < globalData.length; i++) {
            const row = globalData[i];
            const rawPart = row[partCol];
            let rawQty = parseFloat(row[qtyCol]) || 0;
            
            if (rawPart && rawQty > 0) {
                const finalQty = rawQty * batchSize;
                // --- ç”¢ç”Ÿè³‡æ–™åˆ— (å¡«å…¥ B å’Œ F) ---
                outputData.push([
                    "",         // A (ç•™ç™½)
                    rawPart,    // B (å¡«å…¥æ–™è™Ÿ)
                    "",         // C
                    "",         // D
                    "",         // E
                    finalQty    // F (å¡«å…¥æ•¸é‡)
                ]);
            }
        }

        const newWs = XLSX.utils.aoa_to_sheet(outputData);
        const newWb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWb, newWs, "MouserBOM");
        XLSX.writeFile(newWb, `${projectName}_MouserTemplate.xlsx`);
        
        document.getElementById('status').innerText = "âœ… ä¸‹è¼‰å®Œæˆï¼è«‹æª¢æŸ¥ B æ¬„èˆ‡ F æ¬„ã€‚";
    }
</script>

</body>
</html>
