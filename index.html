<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOM 旗艦備料系統 V10 (分頁/大字版)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0046ad; --digikey: #cc0000; --elem14: #ff6600; --light: #f4f6f9; --border: #e0e0e0; --success: #28a745; --info: #17a2b8; --danger: #dc3545; }
        
        /* 3. 字體放大與寬度調整 */
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background-color: var(--light); margin: 0; padding: 20px; color: #333; font-size: 16px; } /* 基底字體放大 */
        
        .container { max-width: 95%; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); overflow: hidden; min-width: 1000px; }
        
        /* Stepper */
        .stepper { display: flex; justify-content: space-between; padding: 25px 50px; background: #fafafa; border-bottom: 1px solid var(--border); }
        .step { text-align: center; flex: 1; opacity: 0.5; font-weight: bold; font-size: 1.1em; }
        .step.active { opacity: 1; color: var(--primary); }
        .step i { display: block; font-size: 28px; margin-bottom: 8px; }

        .step-content { display: none; padding: 40px; }
        .step-content.active { display: block; }

        /* Upload */
        .upload-zone { border: 3px dashed #aaa; border-radius: 10px; padding: 80px; text-align: center; cursor: pointer; transition: 0.3s; background: #fff; }
        .upload-zone:hover { border-color: var(--primary); background-color: #f0f7ff; }

        /* Settings Panel */
        .settings-panel { display: flex; gap: 25px; margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #eee; }
        .setting-item { flex: 1; }
        .setting-item label { font-weight: bold; display: block; margin-bottom: 8px; font-size: 1rem; }
        .setting-item input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }

        /* Toolbar */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .selection-tools button { font-size: 1rem; padding: 8px 15px; cursor: pointer; border: 1px solid #ccc; background: white; border-radius: 4px; margin-right: 8px; }
        .selection-tools button:hover { background: #eee; }

        /* Table - 字體加大 */
        .table-container { min-height: 400px; border: 1px solid #eee; border-radius: 4px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 1rem; } /* 表格字體放大 */
        th { background: #eaeaea; padding: 15px; text-align: left; border-bottom: 2px solid #ccc; font-size: 1.05rem; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background-color: #f9f9f9; }
        tr.excluded { background-color: #ffeef0; color: #aaa; text-decoration: line-through; }
        tr.selected { background-color: #e3f2fd; }

        /* Status Badges */
        .badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.9em; display: inline-block; }
        .badge-ok { color: var(--success); background: #e6f9e9; }
        .badge-buffer { color: var(--info); background: #d1ecf1; }
        .badge-del { color: var(--danger); font-style: italic; }

        /* 4. Pagination Controls */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 20px; padding: 10px; background: #fafafa; border-radius: 8px; }
        .page-btn { padding: 8px 16px; border: 1px solid #ccc; background: white; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn:hover:not(:disabled) { background: #e0e0e0; }
        .page-info { font-weight: bold; color: #555; }

        /* Export */
        .export-panel { margin-top: 30px; padding: 25px; background: #f1f3f5; border-radius: 8px; border: 1px solid #ddd; }
        .btn-group { display: flex; gap: 20px; margin-top: 15px; }
        .btn { padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1rem; font-weight: bold; color: white; flex: 1; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-mouser { background: var(--primary); }
        .btn-mouser:hover { background: #003380; transform: translateY(-2px); }
        .btn-digikey { background: var(--digikey); }
        .btn-digikey:hover { background: #990000; transform: translateY(-2px); }
        .btn-elem14 { background: var(--elem14); }
        .btn-elem14:hover { background: #cc5200; transform: translateY(-2px); }
    </style>
</head>
<body>

<div class="container">
    <div class="stepper">
        <div class="step active" id="nav-step1"><i class="fas fa-file-upload"></i> 1. 上傳原始 BOM</div>
        <div class="step" id="nav-step2"><i class="fas fa-microchip"></i> 2. 智慧備料與分頁</div>
    </div>

    <div id="step1" class="step-content active">
        <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-robot" style="font-size: 80px; color: #0046ad; margin-bottom: 25px;"></i>
            <h3>拖曳或點擊上傳 BOM</h3>
            <p style="color: #666; font-size: 1.1rem;">支援大字體、分頁顯示、智慧拋料計算</p>
            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;" onchange="handleFile(this.files[0])" />
        </div>
    </div>

    <div id="step2" class="step-content">
        
        <div class="settings-panel">
            <div class="setting-item" style="flex: 2;">
                <label>專案名稱 (自動年份):</label>
                <input type="text" id="projectName">
            </div>
            <div class="setting-item">
                <label>製作套數 (Batch Size):</label>
                <input type="number" id="batchSize" value="1" min="1" onchange="recalcAndRender()">
            </div>
            <div class="setting-item">
                <label>SMT 拋料數量 (Buffer):</label>
                <input type="number" id="bufferSize" value="20" min="0" onchange="recalcAndRender()">
            </div>
        </div>

        <div class="toolbar">
            <div class="selection-tools">
                <button onclick="selectAll(true)">全選 (All Pages)</button>
                <button onclick="selectAll(false)">全不選</button>
                <button onclick="invertSelection()" style="background: #fff8e1; border-color: #ffc107; color: #856404;">
                    <i class="fas fa-exchange-alt"></i> 反向選取 (缺貨用)
                </button>
            </div>
            <div id="selectionStats" style="font-weight: bold; color: var(--primary); font-size: 1.1rem;">已選: 0</div>
        </div>

        <div class="table-container">
            <table id="previewTable">
                <thead>
                    <tr>
                        <th width="40"><input type="checkbox" id="masterCheck" onchange="selectAll(this.checked)"></th>
                        <th width="60">Item</th>
                        <th width="100">Part Ref <br><span style="color:#888;font-weight:normal;font-size:0.8em">(縮略顯示)</span></th>
                        <th>Description <br><span style="color:#888;font-weight:normal;font-size:0.8em">(識別用)</span></th>
                        <th>MPN (料號)</th>
                        <th width="80">單量</th>
                        <th width="100">採購總量</th>
                        <th width="150">狀態</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="pagination" id="paginationControls">
            <button class="page-btn" onclick="changePage(-1)" id="btnPrev">❮ 上一頁</button>
            <span class="page-info" id="pageInfo">Page 1 of 1</span>
            <button class="page-btn" onclick="changePage(1)" id="btnNext">下一頁 ❯</button>
        </div>

        <div class="export-panel">
            <span style="font-weight:bold; font-size: 1.1rem;"><i class="fas fa-file-export"></i> 匯出統一格式 (Item, MfrName, MPN, Quantity 1):</span>
            <div class="btn-group">
                <button class="btn btn-mouser" onclick="exportUniversalBOM('Mouser')">Mouser</button>
                <button class="btn btn-digikey" onclick="exportUniversalBOM('Digikey')">DigiKey</button>
                <button class="btn btn-elem14" onclick="exportUniversalBOM('Elem14')">Element14</button>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="location.reload()" style="background:none; border:none; color: #666; cursor:pointer; text-decoration: underline; font-size: 1rem;">處理新檔案</button>
        </div>
    </div>
</div>

<script>
    let rawData = [];
    let tableRows = []; // 所有資料
    let colMap = { item: -1, mfr: -1, part: -1, qty: -1, ref: -1, desc: -1 };
    
    // Pagination Variables
    let currentPage = 1;
    const itemsPerPage = 50;

    // --- File Handling ---
    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });

    function handleFile(file) {
        if (!file) return;
        
        // 1. 動態年份規則: A{YY}_xxx_原始檔名
        const now = new Date();
        const yearSuffix = String(now.getFullYear()).slice(-2); // 取得 "26", "27"
        const baseName = file.name.replace(/\.[^/.]+$/, ""); 
        document.getElementById('projectName').value = `A${yearSuffix}_xxx_${baseName}`;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            analyzeData();
        };
        reader.readAsArrayBuffer(file);
    }

    // --- Analysis Logic ---
    function analyzeData() {
        let headerRowIndex = 7; 
        let foundHeader = false;
        colMap = { item: -1, mfr: -1, part: -1, qty: -1, ref: -1, desc: -1 };

        for (let i = 0; i < Math.min(rawData.length, 20); i++) {
            const rowStr = rawData[i].map(c => String(c).toLowerCase()).join(" ");
            if ((rowStr.includes("part") || rowStr.includes("pn") || rowStr.includes("料號")) && 
                (rowStr.includes("qty") || rowStr.includes("quantity"))) {
                headerRowIndex = i;
                foundHeader = true;
                rawData[i].forEach((cell, idx) => {
                    const c = String(cell).toLowerCase().trim();
                    if (c === "item number" || c === "item" || c === "no.") colMap.item = idx;
                    else if (c === "quantity" || c === "qty") colMap.qty = idx;
                    else if (c.includes("manufacturer pn") || c.includes("mfr part") || c.includes("part_number") || c === "part number") colMap.part = idx;
                    else if ((c === "manufacturer" || c === "mfr" || c === "manufacturer name") && !c.includes("pn")) colMap.mfr = idx;
                    else if (c.includes("reference") || c.includes("ref") || c === "part reference") colMap.ref = idx;
                    else if (c.includes("description") || c.includes("desc")) colMap.desc = idx;
                });
                break;
            }
        }

        if (!foundHeader) {
            headerRowIndex = 7; 
            colMap = { item: 0, qty: 2, ref: 3, desc: 4, mfr: 5, part: 6 };
        } else {
            if (colMap.item === -1) colMap.item = 0;
            if (colMap.qty === -1) colMap.qty = 2;
            if (colMap.ref === -1) colMap.ref = 3; 
            if (colMap.desc === -1) colMap.desc = 4; 
            if (colMap.mfr === -1) colMap.mfr = 5;
            if (colMap.part === -1) colMap.part = 6;
        }

        processTableData(headerRowIndex);
    }

    // --- Data Processing (No Rendering yet) ---
    function processTableData(headerRowIndex) {
        tableRows = [];
        const excludeKeywords = ["PCB FAB", "TDK-INVENSENSE"];

        for (let i = headerRowIndex + 1; i < rawData.length; i++) {
            const row = rawData[i];
            const itemVal = colMap.item !== -1 ? (row[colMap.item] || (i - headerRowIndex)) : (i - headerRowIndex);
            const mfrVal = colMap.mfr !== -1 ? (row[colMap.mfr] || "") : "";
            const partVal = colMap.part !== -1 ? (row[colMap.part] || "") : "";
            const qtyVal = parseFloat(colMap.qty !== -1 ? row[colMap.qty] : 0) || 0;
            const refVal = colMap.ref !== -1 ? String(row[colMap.ref] || "").trim().toUpperCase() : "";
            const descVal = colMap.desc !== -1 ? String(row[colMap.desc] || "").trim().toUpperCase() : "";

            if (!partVal && qtyVal === 0) continue; 

            const rowString = row.join(" ").toUpperCase();
            let isExcluded = false;
            let excludeReason = "";
            if (excludeKeywords.some(k => rowString.includes(k))) {
                isExcluded = true;
                excludeReason = "自動過濾";
            }

            // AI Buffer Logic
            let needBuffer = false;
            if (refVal.startsWith("R") && descVal.includes("RES") && !refVal.startsWith("RP")) needBuffer = true;
            else if (refVal.startsWith("C") && descVal.includes("CAP")) needBuffer = true;
            else if (refVal.startsWith("D") && descVal.includes("LED")) needBuffer = true;
            else if (refVal.startsWith("RP") && descVal.includes("RES ARRAY")) needBuffer = true;

            tableRows.push({ 
                id: i, item: itemVal, mfr: mfrVal, part: partVal, qty: qtyVal, 
                ref: refVal, desc: descVal, 
                checked: !isExcluded, excluded: isExcluded, excludeReason: excludeReason,
                needBuffer: needBuffer
            });
        }

        document.getElementById('step1').classList.remove('active');
        document.getElementById('step2').classList.add('active');
        document.getElementById('nav-step2').classList.add('active');
        
        currentPage = 1; // 重置到第一頁
        recalcAndRender();
    }

    // --- Calculation & Rendering Logic ---
    function recalcAndRender() {
        // 先計算所有資料的數值
        const batchSize = parseInt(document.getElementById('batchSize').value) || 1;
        const bufferSize = parseInt(document.getElementById('bufferSize').value) || 0;

        tableRows.forEach(r => {
            let finalQty = r.qty * batchSize;
            if (!r.excluded && r.needBuffer) {
                finalQty += bufferSize;
            }
            r.finalQty = finalQty;
        });

        updateStats();
        renderPage(); // 只渲染當前頁面
    }

    function renderPage() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";

        // 計算分頁範圍
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageData = tableRows.slice(start, end);

        pageData.forEach(r => {
            const tr = document.createElement('tr');
            tr.id = `row-${r.id}`;
            if (r.excluded) tr.className = 'excluded';
            if (r.checked && !r.excluded) tr.classList.add('selected'); // 保持選取高亮

            // 2. 縮略顯示 Part Ref (只顯示第一個，例如 C46...)
            let displayRef = r.ref;
            if (r.ref.includes(" ")) {
                displayRef = r.ref.split(" ")[0] + "...";
            }

            // 狀態 HTML
            let statusHtml = `<span class="badge badge-ok">OK</span>`;
            if (r.excluded) statusHtml = `<span class="badge badge-del">${r.excludeReason}</span>`;
            else if (r.needBuffer) statusHtml = `<span class="badge badge-buffer"><i class="fas fa-magic"></i> OK (已加拋料)</span>`;

            tr.innerHTML = `
                <td><input type="checkbox" onchange="updateRow(${r.id}, this.checked)" ${r.checked ? 'checked' : ''} ${r.excluded ? 'disabled' : ''}></td>
                <td>${r.item}</td>
                <td style="color:#666; font-weight:bold;">${displayRef}</td>
                <td style="color:#444;">${r.desc}</td>
                <td style="font-weight:bold; color:var(--primary);">${r.part}</td>
                <td>${r.qty}</td>
                <td style="font-weight:bold; font-size:1.1em;">${r.finalQty}</td>
                <td>${statusHtml}</td>
            `;
            tbody.appendChild(tr);
        });

        updatePaginationControls();
    }

    // --- Pagination Controls ---
    function updatePaginationControls() {
        const totalPages = Math.ceil(tableRows.length / itemsPerPage);
        document.getElementById('pageInfo').innerText = `Page ${currentPage} of ${totalPages} (Total ${tableRows.length} items)`;
        document.getElementById('btnPrev').disabled = (currentPage === 1);
        document.getElementById('btnNext').disabled = (currentPage === totalPages || totalPages === 0);
    }

    function changePage(delta) {
        const totalPages = Math.ceil(tableRows.length / itemsPerPage);
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderPage();
            // 滾動到表格頂部
            document.querySelector('.table-container').scrollTop = 0;
        }
    }

    // --- Selection Tools (Operates on ALL Data) ---
    function updateRow(id, checked) {
        const row = tableRows.find(r => r.id === id);
        if (row) {
            row.checked = checked;
            // 如果該行目前可見，更新樣式
            const tr = document.getElementById(`row-${id}`);
            if (tr) {
                if (checked) tr.classList.add('selected'); else tr.classList.remove('selected');
            }
            updateStats();
        }
    }

    function selectAll(checked) {
        document.getElementById('masterCheck').checked = checked;
        // 更新所有資料，不僅僅是當前頁面
        tableRows.forEach(r => {
            if (!r.excluded) r.checked = checked;
        });
        recalcAndRender(); // 重新渲染當前頁面以反映狀態
    }

    function invertSelection() {
        tableRows.forEach(r => {
            if (!r.excluded) r.checked = !r.checked;
        });
        recalcAndRender();
    }

    function updateStats() {
        const count = tableRows.filter(r => r.checked).length;
        document.getElementById('selectionStats').innerText = `已選: ${count} 筆`;
    }

    // --- Export Logic ---
    function exportUniversalBOM(platform) {
        const projectName = document.getElementById('projectName').value;
        const selectedRows = tableRows.filter(r => r.checked && r.part);

        if (selectedRows.length === 0) { alert("沒有勾選任何項目！"); return; }

        let outputData = [];
        outputData.push(["Item Number", "Manufacturer Name", "Manufacturer Part Number", "Quantity 1"]);

        selectedRows.forEach(r => {
            outputData.push([r.item, r.mfr, r.part, r.finalQty]);
        });

        const ws = XLSX.utils.aoa_to_sheet(outputData);
        // Auto Width
        const colWidths = outputData[0].map((_, i) => {
             let max = 15; 
             outputData.forEach(r => { 
                 if(r[i] && String(r[i]).length > max) max = String(r[i]).length; 
             });
             return { wch: max + 2 };
        });
        ws['!cols'] = colWidths;

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "BOM");

        let suffix = "";
        if(platform === 'Mouser') suffix = "_Mouser";
        else if(platform === 'Digikey') suffix = "_Digikey";
        else if(platform === 'Elem14') suffix = "_Elem14";

        const fileName = `${projectName}${suffix}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }
</script>

</body>
</html>
