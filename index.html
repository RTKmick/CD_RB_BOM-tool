<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOM è½‰æ›å™¨ (Mouser å°ˆç”¨)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .container { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-top: 20px; }
        #status { margin-top: 15px; color: blue; font-weight: bold; }
        button { padding: 10px 20px; background-color: #0046ad; color: white; border: none; cursor: pointer; display: none; }
        button:hover { background-color: #003380; }
    </style>
</head>
<body>

    <h2>ğŸ› ï¸ åŸå§‹ BOM -> Mouser BOM è½‰æ›å™¨</h2>
    <p>è«‹ä¸Šå‚³æ‚¨çš„åŸå§‹ BOM è¡¨ (Excel)ï¼Œç³»çµ±å°‡è‡ªå‹•æå–æ–™è™Ÿèˆ‡æ•¸é‡ã€‚</p>

    <div class="container">
        <input type="file" id="upload" accept=".xlsx, .xls" />
        <div id="status">ç­‰å¾…æª”æ¡ˆ...</div>
        <br>
        <button id="downloadBtn">ä¸‹è¼‰ Mouser æ ¼å¼ BOM</button>
    </div>

    <script>
        let processedData = [];

        document.getElementById('upload').addEventListener('change', handleFile);
        document.getElementById('downloadBtn').addEventListener('click', downloadFile);

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½‰æ›ç‚º JSON æ ¼å¼ (Array of Arrays)
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                processBOM(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        function processBOM(data) {
            // 1. å°‹æ‰¾ Header æ‰€åœ¨çš„åˆ— (ç°¡å–®é‚è¼¯ï¼šæ‰¾åŒ…å« 'Part' æˆ– 'æ–™è™Ÿ' çš„é‚£ä¸€åˆ—)
            let headerRowIndex = -1;
            let partColIndex = -1;
            let qtyColIndex = -1;

            // é—œéµå­—å­—å…¸ (å¯è‡ªè¡Œæ“´å……)
            const partKeywords = ['part no', 'p/n', 'mfr part', 'æ–™è™Ÿ', 'å‹è™Ÿ', 'part number'];
            const qtyKeywords = ['qty', 'quantity', 'æ•¸é‡', 'amount'];

            // æƒæå‰ 10 è¡Œæ‰¾ Header
            for (let i = 0; i < Math.min(data.length, 10); i++) {
                const row = data[i];
                for (let j = 0; j < row.length; j++) {
                    const cell = String(row[j]).toLowerCase();
                    if (partKeywords.some(k => cell.includes(k)) && partColIndex === -1) {
                        headerRowIndex = i;
                        partColIndex = j;
                    }
                    if (qtyKeywords.some(k => cell.includes(k)) && qtyColIndex === -1) {
                        qtyColIndex = j;
                    }
                }
                if (headerRowIndex !== -1) break; // æ‰¾åˆ° Header å°±åœæ­¢
            }

            if (headerRowIndex === -1 || partColIndex === -1) {
                document.getElementById('status').innerText = "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° 'æ–™è™Ÿ' æ¬„ä½ï¼Œè«‹æª¢æŸ¥ Excel æ¨™é¡Œã€‚";
                return;
            }

            // 2. æå–è³‡æ–™ä¸¦æ­£è¦åŒ–
            processedData = [];
            // åŠ å…¥ Mouser è¦æ±‚çš„ Header (Mouser å…¶å¯¦æ”¯æ´è‡ªè¨‚æ˜ å°„ï¼Œä½†æ¨™æº–åŒ–æœ€å¥½)
            processedData.push(["Mfr Part Number", "Quantity", "Customer Reference"]); 

            for (let i = headerRowIndex + 1; i < data.length; i++) {
                const row = data[i];
                const partNum = row[partColIndex];
                const qty = qtyColIndex !== -1 ? row[qtyColIndex] : 1; // æ²’æ•¸é‡é è¨­ç‚º 1

                if (partNum) {
                    processedData.push([partNum, qty, "Auto-Converted"]);
                }
            }

            document.getElementById('status').innerText = `âœ… è™•ç†å®Œæˆï¼å…± ${processedData.length - 1} ç­†æ–™è™Ÿã€‚`;
            document.getElementById('downloadBtn').style.display = 'inline-block';
        }

        function downloadFile() {
            // å»ºç«‹æ–°çš„ Workbook
            const newWs = XLSX.utils.aoa_to_sheet(processedData);
            const newWb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(newWb, newWs, "MouserBOM");

            // åŒ¯å‡ºæª”æ¡ˆ
            XLSX.writeFile(newWb, "Mouser_Upload_BOM.xlsx");
        }
    </script>
</body>
</html>
